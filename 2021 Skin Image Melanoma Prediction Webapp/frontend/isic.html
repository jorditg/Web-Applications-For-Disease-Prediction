<!DOCTYPE html>

<html>
  <head>
    <title>Skin Lesion Detection</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="./dist/jcrop.css" />
    <meta charset="UTF-8" >
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.9-1/crypto-js.js"></script>
  </head>
  <body>

    <div style="padding:0 5%;">

      <h1 style="font-family:Helvetica,sans-serif;">
        Skin Lesion Detection <span style="color:lightgray;">- crop and analyze!</span>
      </h1>

      <div style="margin-top:0.5em;">
        <input type="file"  accept="image/*" name="image" id="file"  onchange="loadImage(event)" />
      </div>

      <img id="target" src="" title="" style="max-height:2400px;max-width:3800px;height:auto;width:auto" />      

      <div style="margin-top:0.5em;">
        <button onclick="updateOutput()">Crop</button>
        <input type="checkbox" id="aspect_ratio" name="aspect_ratio" value="1/1" onchange="aspect_ratio()" form="my_form" />
        <label for="aspect_ratio">1:1</label><br>
        <button onclick="updateOutput2()">Resize</button>
        <button onclick="updateRot90()">Rot90</button>
        <button onclick="updateFlipV()">FlipV</button>
        <button onclick="updateFlipH()">FlipH</button>
        <!-- 
        <button onclick="updateRotate()">Rotate</button>
        <select id="angle">
          <option value="45.0" selected>+45</option>
          <option value="30.0">+30</option>
          <option value="20.0">+20</option>
          <option value="10.0">+10</option>
          <option value="-10.0">-10</option>          
          <option value="-20.0">-20</option>
          <option value="-30.0">-30</option>
          <option value="-45.0">-45</option>
        </select>
        -->
      </div>

      <canvas id="output" src = "" > </canvas>

      <div style="margin-top:0.5em;">
        <button onclick="submit()">Submit</button>
      </div>

      <div style="margin-top:0.5em;">
        <h3 id="result"></h3>
      </div>

    </div>

    <script src="./dist/jcrop.js"></script>
    <script src="opencv.js" type="text/javascript"></script>

    <script>
      var jcp; // jcrop object
      var pos; // selection position: pos.x,pos.y,pos.w,pos.h
      const id = "target";
      var element = document.getElementById(id);
      var options = {
        multi:false,
        shadeColor:'black',
        shadeOpacity:0.2
      }
      var operations = "";

      Jcrop.load(id).then(img => {

        jcp = Jcrop.attach(img, options);
        
        rect = Jcrop.Rect.create(0, 0, element.width, element.height);
        jcp.newWidget(rect, {});
        //console.log(element.width, element.height);

        jcp.focus();

        jcp.listen('crop.change',(widget,e) => {
          pos = widget.pos;
          //console.log(pos.x,pos.y,pos.w,pos.h);
        });
      });

      function loadImage(event){
        var image = document.getElementById('target');
        //image.src = URL.createObjectURL(event.target.files[0]);
        image.src = window.URL.createObjectURL(event.target.files[0]);
        image.title = event.target.files[0].name;
        image.type = event.target.files[0].type;
        image.onload = () => {
          jcp = Jcrop.attach(image, options);
          jcp.removeWidget(jcp.active);
          rect = Jcrop.Rect.create(0, 0, image.width, image.height);
          jcp.newWidget(rect, {});
          jcp.focus();
          pos = jcp.active.pos;
          //console.log(jcp.active.pos);
          jcp.listen('crop.change',(widget,e) => {
            pos = widget.pos;
          });
        };


      };

      function updateOutput(){
        var input_image = document.getElementById('target');
        var output_image = document.getElementById('output');
        var rect = new cv.Rect(pos.x,pos.y,pos.w,pos.h);
        var src = cv.imread(input_image);
        var dst = new cv.Mat();
        dst = src.roi(rect);
        cv.imshow(output_image, dst);
        src.delete();
        dst.delete();
        operations = "";
      };


      function updateOutput2(){
        var image = document.getElementById('output');
        var src = cv.imread(image);
        var dst = new cv.Mat();
        var dsize = new cv.Size(456, 456);
        cv.resize(src, dst, dsize, 0, 0, cv.INTER_AREA);
        cv.imshow(image, dst);
        src.delete(); 
        dst.delete();
        operations = operations + ":RESIZE_456x456";
      };

      function updateRot90(){
        var image = document.getElementById('output');
        var src = cv.imread(image);
        var dst = new cv.Mat();
        cv.rotate(src, dst, cv.ROTATE_90_CLOCKWISE);
        cv.imshow(image, dst);
        src.delete(); 
        dst.delete();
        operations = operations + ":ROT_90"
      };

      function updateFlipV(){
        var image = document.getElementById('output');
        var src = cv.imread(image);
        var dst = new cv.Mat();
        cv.flip(src, dst, 0);
        cv.imshow(image, dst);
        src.delete(); 
        dst.delete();
        operations = operations + ":FLIP_V"        
      };

      function updateFlipH(){
        var image = document.getElementById('output');
        var src = cv.imread(image);
        var dst = new cv.Mat();
        cv.flip(src, dst, +1);
        cv.imshow(image, dst);
        src.delete(); 
        dst.delete();
        operations = operations + ":FLIP_H"        
      };

      function updateRotate(){
        var image = document.getElementById('output');
        var src = cv.imread(image);
        var dst = new cv.Mat();
        var angle = parseFloat(document.getElementById('angle').value);
        var dsize = new cv.Size(src.width, src.height);
        var center = new cv.Point(src.width / 2, src.height / 2);
        var M = cv.getRotationMatrix2D(center, angle, 1);
        cv.warpAffine(src, dst, M, dsize, cv.INTER_LINEAR, cv.BORDER_CONSTANT, new cv.Scalar());
        cv.imshow(image, dst);
        src.delete(); 
        dst.delete();
        M.delete();
        operations = operations + ":ROT"        
      };      

      function aspect_ratio()
      {
        if (document.getElementById('aspect_ratio').checked) 
        {
            jcp.setOptions({ aspectRatio: 1 / 1 });            
        } else {
            jcp.setOptions({ aspectRatio: 0 });            
        }
        jcp.focus();
      }

      function showname () {
        var name = document.getElementById('target'); 
        alert('Selected file: ' + name.files.item(0).name);
        alert('Selected file: ' + name.files.item(0).size);
        alert('Selected file: ' + name.files.item(0).type);
      };

      function submit(canvas) {
        // clear previous results
        document.getElementById("result").innerText = "Evaluating ...";

        var file = document.getElementById('file');
        var img = document.getElementById('target');
        var name = file.files.item(0).name;
        var data = new FormData();
        var canvas = document.getElementById("output");

        var name_noext = name.substr(0, name.lastIndexOf('.'));
        var ext = name.substr(name.lastIndexOf('.')+1);                 

        canvas.toBlob(function (blob) {          
          var hash = CryptoJS.SHA1(blob);  
          var newfilename = name_noext + "." + hash + "." + ext;

          //alert(newfilename);

          //var fileOfBlob = new File([blob], name.files.item(0).name)
          var fileOfBlob = new File([blob], newfilename)
          data.append('file', fileOfBlob);

          data.append('crop_posx', pos.x);
          data.append('crop_posy', pos.y);
          data.append('crop_posw', pos.w);
          data.append('crop_posh', pos.h);
          data.append('orig_width', img.width);
          data.append('orig_height', img.height);
          data.append('operations', operations)

          axios
            .post('http://localhost:5001/upload', data, {
                  headers: {
                    'Content-Type': 'multipart/form-data',
                  },
            })
            .then(response => {
              console.log(response.data.label);
              document.getElementById("result").innerText = response.data.label + "\n Normal=" + response.data.normal + " % Melanoma=" + response.data.melanoma + " %";
            });
        }, file.files.item(0).type, 0.95);
      } 
    </script>
  </body>
</html>
